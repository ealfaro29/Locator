<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Locator (MapLibre / Full Feature)</title>
  <link href='https://unpkg.com/maplibre-gl/dist/maplibre-gl.css' rel='stylesheet' />
  
  <style>
    :root {
      --bg-card: #ffffff;
      --bg-main: #f8f9fa;
      --accent: #007bff;
      --accent-hover: #0056b3;
      --text-color: #333;
      --text-muted: #6c757d;
      --border-color: #dee2e6;
      --radius: 6px;
      --spacing: 12px;
      --sidebar-width: 320px;
      --font: 100%/1.4 system-ui, sans-serif;
      --remove-btn-color: #dc3545;
      --ocean-blue: #ddeeff;
      --land-fill: #f0f0f0;
      --country-border: #bbbbbb;
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      font: var(--font); 
      color: var(--text-color);
      background-color: var(--bg-main);
      overflow: hidden;
    }

    .app-container { display: flex; height: 100vh; }
    #sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: var(--bg-card); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: var(--spacing); gap: calc(var(--spacing) * 1.5); z-index: 1000; }
    #map-container { position: relative; flex: 1; height: 100%; }
    #map { width: 100%; height: 100%; }

    .sidebar-header { padding-bottom: var(--spacing); border-bottom: 1px solid var(--border-color); }
    #logo { width: 100%; max-width: 200px; display: block; margin: 0 auto; }

    .sidebar-section { display: flex; flex-direction: column; gap: calc(var(--spacing) / 2); }
    .sidebar-section label { font-weight: bold; font-size: 0.9em; color: var(--text-muted); }
    .sidebar-section h3 { margin: 0; }
    .scrollable-list { flex: 1; min-height: 0; overflow-y: auto; }
    .sidebar-footer { margin-top: auto; padding-top: var(--spacing); border-top: 1px solid var(--border-color); }

    input[type="text"], select, textarea, button { border: 1px solid var(--border-color); border-radius: var(--radius); padding: calc(var(--spacing) / 1.5); font: inherit; width: 100%; }
    input[type="text"]:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
    button { cursor: pointer; text-align: center; position: relative; }
    button.primary-button, button#ambiguity-popup-ok { background: var(--accent); color: #fff; border: none; }
    button.primary-button:hover, button#ambiguity-popup-ok:hover { background: var(--accent-hover); }
    button#ambiguity-popup-skip { background-color: #fff; color: var(--text-color); border: 1px solid var(--border-color); }
    button#ambiguity-popup-skip:hover { background-color: #f8f9fa; }
    button:disabled { background: #ccc; cursor: not-allowed; color: #777; }

    .location-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) / 2); }
    .fill-toggle-label { font-size: 0.85em; font-weight: normal; cursor: pointer; user-select:none; }
    .fill-toggle-checkbox { margin-right: 4px; vertical-align: middle; }

    #location-list { list-style: none; padding: 0; margin: 0; }
    #location-list li { display: flex; align-items: center; gap: 8px; padding: 8px; border-bottom: 1px solid #f0f0f0; }
    #location-list li:hover { background-color: #f8f9fa; }
    #location-list li .location-name { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #location-list li.is-editing .location-name { display: none; }
    #location-list li .location-edit-input { display: none; flex: 1; }
    #location-list li.is-editing .location-edit-input { display: block; }
    #location-list li.not-found .location-name { color: var(--remove-btn-color); font-style: italic; }
    .location-controls { display: flex; gap: 4px; }
    .location-controls button { background: none; border: none; padding: 4px; font-size: 16px; cursor: pointer; color: var(--text-muted); line-height: 1; border-radius: var(--radius); width: auto; }
    .location-controls button:hover { color: var(--text-color); background-color: #e9ecef; }
    .location-controls button.remove-btn:hover { color: var(--remove-btn-color); }

    .popup-base { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); padding: var(--spacing); border-radius: var(--radius); box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 2002; width: 300px; display: none; flex-direction: column; gap: var(--spacing); border: 1px solid var(--border-color); }
    .popup-base select { width: 100%; }
    .actions { display: flex; justify-content: flex-end; gap: 8px; }

    .maplibregl-popup-content { background: #fff; padding: 5px 10px !important; font: var(--font); font-size: 0.8em; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border-radius: var(--radius) !important; border: 1px solid #ccc; }
    .maplibregl-popup-close-button { display: none; }

    .hidden { display: none !important; }
    .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #map-overlay-controls { position: absolute; bottom: 0; right: 0; background-color: rgba(255, 255, 255, 0.7); padding: 2px 8px; border-top-left-radius: var(--radius); z-index: 999; display: flex; align-items: center; gap: 8px; }
    .wiki-link { font-size: 0.8em; font-weight: normal; text-decoration: none; color: var(--accent); }
    .wiki-link:hover { text-decoration: underline; }
    .attribution-notice { font-size: 0.7em; color: var(--text-muted); }
    .attribution-notice a { color: var(--text-muted); text-decoration: none; }
    .attribution-notice a:hover { text-decoration: underline; }

    #wiki-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1998; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
    #wiki-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
    #wiki-sidebar { position: fixed; top: 0; right: 0; width: 400px; max-width: 90%; height: 100%; background-color: var(--bg-card); box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 1999; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
    #wiki-sidebar.active { transform: translateX(0); }

    .wiki-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .wiki-header h3 { margin: 0; }
    #wiki-close-btn { font-size: 24px; font-weight: bold; line-height: 1; color: var(--text-muted); background: none; border: none; padding: 4px 8px; width: auto; }
    #wiki-close-btn:hover { color: var(--text-color); }

    #wiki-content { padding: var(--spacing); overflow-y: auto; flex-grow: 1; }
    #wiki-content h4 { margin-top: calc(var(--spacing) * 1.5); margin-bottom: calc(var(--spacing) / 2); }
    #wiki-content p { margin: 0 0 var(--spacing) 0; line-height: 1.6; }
    #wiki-content a { color: var(--accent); }
    #wiki-content code { background-color: #e9ecef; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
  </style>
</head>
<body>

  <div class="app-container">
    
    <aside id="sidebar">
      <div class="sidebar-header">
        <img id="logo" src="https://deckard.openprocessing.org/user477727/visual2655711/h97b445f78fd20b46a48ec1e5193357e1/locator_logo.png" alt="Locator Logo">
      </div>

      <div class="sidebar-section">
        <label for="locations">Add Locations</label>
        <textarea id="locations" placeholder="e.g., Paris; London
Separate with ';' or new line" rows="3"></textarea>
        <button id="locateBtn" class="primary-button">
          <span class="btn-text">Add to Map</span>
          <span class="spinner hidden"></span>
        </button>
      </div>

      <div class="sidebar-section scrollable-list">
        <div class="location-list-header">
          <h3>Locations</h3>
          <label class="fill-toggle-label">
            <input type="checkbox" id="fillCountriesCheckbox" class="fill-toggle-checkbox">
            Fill Countries
          </label>
        </div>
        <ul id="location-list">
          <!-- Location items will be added here -->
        </ul>
      </div>
      
      <div class="sidebar-footer"></div>
    </aside>

    <main id="map-container">
      <div id="map"></div>
      <div id="map-overlay-controls">
        <a href="#" id="wiki-open-btn" class="wiki-link">[INFO]</a>
        <div class="attribution-notice">
          Map data from <a href="https://www.naturalearthdata.com/" target="_blank">Natural Earth</a>
        </div>
      </div>
    </main>
  </div>

  <!-- Ambiguity Popup -->
  <div id="ambiguity-popup-overlay" class="popup-base" role="dialog">
    <p id="ambiguity-popup-msg"></p>
    <select id="ambiguity-popup-select"></select>
    <div class="actions">
      <button id="ambiguity-popup-ok">Select</button>
      <button id="ambiguity-popup-skip">Skip</button>
    </div>
  </div>

  <!-- Wiki Sidebar -->
  <div id="wiki-overlay" class="hidden"></div>
  <aside id="wiki-sidebar" class="hidden">
    <div class="wiki-header">
      <h3 id="wiki-title">Wiki</h3>
      <button id="wiki-close-btn" title="Close">×</button>
    </div>
    <div id="wiki-content">
      <!-- Wiki content will be loaded here -->
    </div>
  </aside>

  <script src='https://unpkg.com/maplibre-gl/dist/maplibre-gl.js'></script>
  
  <script>
    // --- EMBEDDED DATA ---
    const WIKI_DATA = {
      "title": "Locator App Wiki",
      "sections": [
        { "title": "Overview", "content": ["Locator is a simple tool for geocoding a list of locations and displaying them on a minimalist world map. It is designed for quick, internal visualization tasks and requires no sign-ups to use."] },
        { "title": "How to Use", "content": ["<b>1. Add Locations:</b> Type or paste location names into the text area. Separate each location with a semicolon (;) or a new line.", "<b>2. Add to Map:</b> Click the 'Add to Map' button. The app will process each location one by one.", "<b>3. Resolve Ambiguity:</b> If a location name has multiple possible matches (e.g., 'Springfield'), a popup will appear. Select the correct one from the list and click 'Select', or click 'Skip' to ignore it.", "<b>4. Manage the List:</b> Each successfully added location appears in the list on the left. You can use the buttons to:", "  - ✏️ <b>Rename:</b> Edit the location's label on the map.", "  - 🔍 <b>Zoom To:</b> Pan and zoom the map to that location.", "  - 🗑️ <b>Remove:</b> Delete the location from the map and the list.", "<b>5. Fill Countries:</b> Check the 'Fill Countries' box to highlight the countries where you have placed locations."] },
        { "title": "Technical Stack", "content": ["<b>Mapping Library:</b> MapLibre GL JS", "<b>User Interface:</b> Vanilla JavaScript (ES6), HTML5, CSS3", "<b>Dependencies:</b> All dependencies are loaded via CDN and require no local installation."] },
        { "title": "Data Sources", "content": ["<b>Base Map:</b> Country outlines are from <a href='https://www.naturalearthdata.com/' target='_blank'>Natural Earth</a> (Public Domain).", "<b>Geocoding (Search):</b> Location search is performed using the public <a href='https://nominatim.org/' target='_blank'>Nominatim API</a>, which uses OpenStreetMap data.", "<b>Compliance:</b> To respect Nominatim's usage policy, this tool sends a unique <code>User-Agent</code> header and enforces a 1-second delay between search requests."] }
      ]
    };

    const ISO_A2_TO_A3_DATA = { "AF": "AFG", "AX": "ALA", "AL": "ALB", "DZ": "DZA", "AS": "ASM", "AD": "AND", "AO": "AGO", "AI": "AIA", "AQ": "ATA", "AG": "ATG", "AR": "ARG", "AM": "ARM", "AW": "ABW", "AU": "AUS", "AT": "AUT", "AZ": "AZE", "BS": "BHS", "BH": "BHR", "BD": "BGD", "BB": "BRB", "BY": "BLR", "BE": "BEL", "BZ": "BLZ", "BJ": "BEN", "BM": "BMU", "BT": "BTN", "BO": "BOL", "BQ": "BES", "BA": "BIH", "BW": "BWA", "BV": "BVT", "BR": "BRA", "IO": "IOT", "BN": "BRN", "BG": "BGR", "BF": "BFA", "BI": "BDI", "CV": "CPV", "KH": "KHM", "CM": "CMR", "CA": "CAN", "KY": "CYM", "CF": "CAF", "TD": "TCD", "CL": "CHL", "CN": "CHN", "CX": "CXR", "CC": "CCK", "CO": "COL", "KM": "COM", "CD": "COD", "CG": "COG", "CK": "COK", "CR": "CRI", "CI": "CIV", "HR": "HRV", "CU": "CUB", "CW": "CUW", "CY": "CYP", "CZ": "CZE", "DK": "DNK", "DJ": "DJI", "DM": "DMA", "DO": "DOM", "EC": "ECU", "EG": "EGY", "SV": "SLV", "GQ": "GNQ", "ER": "ERI", "EE": "EST", "SZ": "SWZ", "ET": "ETH", "FK": "FLK", "FO": "FRO", "FJ": "FJI", "FI": "FIN", "FR": "FRA", "GF": "GUF", "PF": "PYF", "TF": "ATF", "GA": "GAB", "GM": "GMB", "GE": "GEO", "DE": "DEU", "GH": "GHA", "GI": "GIB", "GR": "GRC", "GL": "GRL", "GD": "GRD", "GP": "GLP", "GU": "GUM", "GT": "GTM", "GG": "GGY", "GN": "GIN", "GW": "GNB", "GY": "GUY", "HT": "HTI", "HM": "HMD", "VA": "VAT", "HN": "HND", "HK": "HKG", "HU": "HUN", "IS": "ISL", "IN": "IND", "ID": "IDN", "IR": "IRN", "IQ": "IRQ", "IE": "IRL", "IM": "IMN", "IL": "ISR", "IT": "ITA", "JM": "JAM", "JP": "JPN", "JE": "JEY", "JO": "JOR", "KZ": "KAZ", "KE": "KEN", "KI": "KIR", "KP": "PRK", "KR": "KOR", "KW": "KWT", "KG": "KGZ", "LA": "LAO", "LV": "LVA", "LB": "LBN", "LS": "LSO", "LR": "LBR", "LY": "LBY", "LI": "LIE", "LT": "LTU", "LU": "LUX", "MO": "MAC", "MG": "MDG", "MW": "MWI", "MY": "MYS", "MV": "MDV", "ML": "MLI", "MT": "MLT", "MH": "MHL", "MQ": "MTQ", "MR": "MRT", "MU": "MUS", "YT": "MYT", "MX": "MEX", "FM": "FSM", "MD": "MDA", "MC": "MCO", "MN": "MNG", "ME": "MNE", "MS": "MSR", "MA": "MAR", "MZ": "MOZ", "MM": "MMR", "NA": "NAM", "NR": "NRU", "NP": "NPL", "NL": "NLD", "NC": "NCL", "NZ": "NZL", "NI": "NIC", "NE": "NER", "NG": "NGA", "NU": "NIU", "NF": "NFK", "MK": "MKD", "MP": "MNP", "NO": "NOR", "OM": "OMN", "PK": "PAK", "PW": "PLW", "PS": "PSE", "PA": "PAN", "PG": "PNG", "PY": "PRY", "PE": "PER", "PH": "PHL", "PN": "PCN", "PL": "POL", "PT": "PRT", "PR": "PRI", "QA": "QAT", "RE": "REU", "RO": "ROU", "RU": "RUS", "RW": "RWA", "BL": "BLM", "SH": "SHN", "KN": "KNA", "LC": "LCA", "MF": "MAF", "PM": "SPM", "VC": "VCT", "WS": "WSM", "SM": "SMR", "ST": "STP", "SA": "SAU", "SN": "SEN", "RS": "SRB", "SC": "SYC", "SL": "SLE", "SG": "SGP", "SX": "SXM", "SK": "SVK", "SI": "SVN", "SB": "SLB", "SO": "SOM", "ZA": "ZAF", "GS": "SGS", "SS": "SSD", "ES": "ESP", "LK": "LKA", "SD": "SDN", "SR": "SUR", "SJ": "SJM", "SE": "SWE", "CH": "CHE", "SY": "SYR", "TW": "TWN", "TJ": "TJK", "TZ": "TZA", "TH": "THA", "TL": "TLS", "TG": "TGO", "TK": "TKL", "TO": "TON", "TT": "TTO", "TN": "TUN", "TR": "TUR", "TM": "TKM", "TC": "TCA", "TV": "TUV", "UG": "UGA", "UA": "UKR", "AE": "ARE", "GB": "GBR", "UM": "UMI", "US": "USA", "UY": "URY", "UZ": "UZB", "VU": "VUT", "VE": "VEN", "VN": "VNM", "VG": "VGB", "VI": "VIR", "WF": "WLF", "EH": "ESH", "YE": "YEM", "ZM": "ZMB", "ZW": "ZWE" };

    // --- MAIN APPLICATION LOGIC ---
    const App = {
        CONFIG: {
            API_THROTTLE_MS: 1000,
            GEOJSON_URL: 'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_50m_admin_0_countries.geojson'
        },
        map: null, locationsData: [], geocodeQueue: [], ambiguityChoices: [], ambiguityOriginalQuery: '', locatedCountryCodes: new Set(), isWikiLoaded: false, isoLookup: null, elements: {}, cssColors: {},

        init() {
            this.cacheDOMElementsAndStyles();
            this.loadEmbeddedData();
            this.initMap();
            this.bindEvents();
        },

        cacheDOMElementsAndStyles() {
            this.elements = {
                locateBtn: document.getElementById('locateBtn'), locationsInput: document.getElementById('locations'), locationList: document.getElementById('location-list'), mapElement: document.getElementById('map'), fillCountriesCheckbox: document.getElementById('fillCountriesCheckbox'), locateBtnSpinner: document.querySelector('#locateBtn .spinner'), locateBtnText: document.querySelector('#locateBtn .btn-text'), ambiguityPopup: document.getElementById('ambiguity-popup-overlay'), ambiguityMsg: document.getElementById('ambiguity-popup-msg'), ambiguitySelect: document.getElementById('ambiguity-popup-select'), ambiguityOkBtn: document.getElementById('ambiguity-popup-ok'), ambiguitySkipBtn: document.getElementById('ambiguity-popup-skip'), wikiOpenBtn: document.getElementById('wiki-open-btn'), wikiSidebar: document.getElementById('wiki-sidebar'), wikiOverlay: document.getElementById('wiki-overlay'), wikiCloseBtn: document.getElementById('wiki-close-btn'), wikiTitle: document.getElementById('wiki-title'), wikiContent: document.getElementById('wiki-content'),
            };
            const rootStyle = getComputedStyle(document.documentElement);
            this.cssColors = { land: rootStyle.getPropertyValue('--land-fill').trim(), accent: rootStyle.getPropertyValue('--accent').trim() };
        },
        
        loadEmbeddedData() {
            this.isoLookup = ISO_A2_TO_A3_DATA;
            if (!this.isoLookup) {
                console.error('Fatal Error: Could not load ISO country code lookup. Fill Countries feature will be disabled.');
                this.elements.fillCountriesCheckbox.disabled = true;
                const label = this.elements.fillCountriesCheckbox.closest('label');
                if (label) {
                    label.title = 'Country code data failed to load.';
                    label.style.opacity = '0.5';
                    label.style.cursor = 'not-allowed';
                }
            }
        },

        initMap() {
            this.map = new maplibregl.Map({
                container: this.elements.mapElement, style: { version: 8, sources: {}, layers: [{ id: 'background', type: 'background', paint: { 'background-color': '#ddeeff' } }] }, center: [0, 20], zoom: 1.5, attributionControl: false
            });
            this.map.on('load', () => {
                this.map.addSource('countries-source', { type: 'geojson', data: this.CONFIG.GEOJSON_URL });
                this.map.addLayer({ id: 'countries-fill-layer', type: 'fill', source: 'countries-source', paint: { 'fill-color': this.cssColors.land, 'fill-opacity': 1 } });
                this.map.addLayer({ id: 'countries-border-layer', type: 'line', source: 'countries-source', paint: { 'line-color': '#bbbbbb', 'line-width': 0.5 } });
            });
            this.map.addControl(new maplibregl.NavigationControl(), 'top-right');
            this.map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');
        },

        bindEvents() {
            this.elements.locateBtn.onclick = () => this.startGeocoding();
            this.elements.ambiguityOkBtn.onclick = () => this.resolveAmbiguity();
            this.elements.ambiguitySkipBtn.onclick = () => this.skipAmbiguity();
            this.elements.fillCountriesCheckbox.addEventListener('change', () => this.updateCountryFills());
            this.elements.locationList.addEventListener('click', (e) => this.handleLocationListClick(e));
            this.elements.wikiOpenBtn.addEventListener('click', (e) => { e.preventDefault(); this.openWiki(); });
            this.elements.wikiCloseBtn.addEventListener('click', () => this.closeWiki());
            this.elements.wikiOverlay.addEventListener('click', () => this.closeWiki());
        },

        openWiki() {
            if (!this.isWikiLoaded) this.loadAndRenderWiki();
            this.elements.wikiOverlay.classList.remove('hidden');
            this.elements.wikiSidebar.classList.remove('hidden');
            requestAnimationFrame(() => { this.elements.wikiSidebar.classList.add('active'); });
        },

        closeWiki() {
            this.elements.wikiSidebar.classList.remove('active');
            this.elements.wikiOverlay.classList.add('hidden');
        },
        
        loadAndRenderWiki() {
            try {
                const wikiData = WIKI_DATA;
                this.elements.wikiTitle.textContent = wikiData.title;
                this.elements.wikiContent.innerHTML = '';
                wikiData.sections.forEach(section => {
                    const sectionTitle = document.createElement('h4');
                    sectionTitle.textContent = section.title;
                    this.elements.wikiContent.appendChild(sectionTitle);
                    section.content.forEach(paragraphText => {
                        const p = document.createElement('p');
                        p.innerHTML = paragraphText;
                        this.elements.wikiContent.appendChild(p);
                    });
                });
                this.isWikiLoaded = true;
            } catch (error) {
                console.error('Failed to load wiki:', error);
                this.elements.wikiContent.innerHTML = '<p>Error: Could not load the wiki documentation.</p>';
            }
        },

        placeLocation(result, originalQuery) {
            const markerId = Date.now();
            const labelText = result.display_name.split(',')[0];
            const coordinates = [parseFloat(result.lon), parseFloat(result.lat)];
            const countryCodeA2 = (result.address && result.address.country_code) ? result.address.country_code.toUpperCase() : null;
            const countryCodeA3 = this.isoLookup ? this.isoLookup[countryCodeA2] : null;
            const marker = new maplibregl.Marker().setLngLat(coordinates).addTo(this.map);
            const labelPopup = new maplibregl.Popup({ closeOnClick: false, closeButton: false, anchor: 'left', offset: 10 }).setLngLat(coordinates).setHTML(labelText).addTo(this.map);
            this.locationsData.push({ id: markerId, label: labelText, fullName: result.display_name, lon: coordinates[0], lat: coordinates[1], countryCode: countryCodeA3, mapMarker: marker, mapLabelPopup: labelPopup });
            if (countryCodeA3) this.locatedCountryCodes.add(countryCodeA3);
            this.renderListItem({ id: markerId, label: labelText });
            this.updateCountryFills();
        },

        removeLocation(markerId) {
            const index = this.locationsData.findIndex(loc => loc.id === markerId);
            if (index === -1) return;
            const [locationData] = this.locationsData.splice(index, 1);
            locationData.mapMarker.remove();
            locationData.mapLabelPopup.remove();
            document.querySelector(`li[data-marker-id="${markerId}"]`).remove();
            this.recalculateLocatedCountries();
            this.updateCountryFills();
        },

        zoomToLocation(markerId) {
            const locationData = this.locationsData.find(loc => loc.id === markerId);
            if (!locationData) return;
            this.map.flyTo({ center: [locationData.lon, locationData.lat], zoom: 9 });
        },

        saveRename(li, markerId, newLabel) {
            li.classList.remove('is-editing');
            const locationData = this.locationsData.find(loc => loc.id === markerId);
            if (!locationData || !newLabel.trim()) return;
            locationData.label = newLabel.trim();
            li.querySelector('.location-name').textContent = locationData.label;
            locationData.mapLabelPopup.setHTML(locationData.label);
        },

        handleLocationListClick(event) {
            const button = event.target.closest('button');
            if (!button) return;
            const li = button.closest('li');
            const markerId = parseInt(li.dataset.markerId, 10);
            const unfoundQuery = li.dataset.query;
            if (button.classList.contains('remove-btn')) {
                if (markerId) this.removeLocation(markerId);
                else if (unfoundQuery) li.remove();
            } else if (button.classList.contains('zoom-btn')) {
                this.zoomToLocation(markerId);
            } else if (button.classList.contains('rename-btn')) {
                this.toggleRename(li, markerId);
            }
        },

        toggleRename(li, markerId) {
            const isEditing = li.classList.toggle('is-editing');
            const nameSpan = li.querySelector('.location-name');
            const input = li.querySelector('.location-edit-input');
            if (isEditing) {
                input.value = nameSpan.textContent;
                input.focus();
                input.select();
                const save = () => this.saveRename(li, markerId, input.value);
                const keydownHandler = (e) => {
                    if (e.key === 'Enter') input.blur();
                    else if (e.key === 'Escape') {
                        li.classList.remove('is-editing');
                        input.removeEventListener('blur', save);
                        input.removeEventListener('keydown', keydownHandler);
                    }
                };
                input.addEventListener('blur', save, { once: true });
                input.addEventListener('keydown', keydownHandler);
            }
        },

        updateCountryFills() {
            if (!this.map.isStyleLoaded() || !this.map.getSource('countries-source')) return;
            if (this.elements.fillCountriesCheckbox.checked && this.locatedCountryCodes.size > 0) {
                const fillColorExpression = ['case', ['in', ['get', 'ADM0_A3'], ['literal', [...this.locatedCountryCodes]]], this.cssColors.accent, this.cssColors.land];
                this.map.setPaintProperty('countries-fill-layer', 'fill-color', fillColorExpression);
                this.map.setPaintProperty('countries-fill-layer', 'fill-opacity', 0.4);
            } else {
                this.map.setPaintProperty('countries-fill-layer', 'fill-color', this.cssColors.land);
                this.map.setPaintProperty('countries-fill-layer', 'fill-opacity', 1);
            }
        },

        recalculateLocatedCountries() {
            this.locatedCountryCodes.clear();
            this.locationsData.forEach(loc => { if (loc.countryCode) this.locatedCountryCodes.add(loc.countryCode); });
        },

        renderListItem(data) {
            const li = document.createElement('li');
            li.dataset.markerId = data.id;
            li.innerHTML = ` <span class="location-name">${data.label}</span> <input type="text" class="location-edit-input" value="${data.label}" /> <div class="location-controls"> <button class="rename-btn" title="Rename">✏️</button> <button class="zoom-btn" title="Zoom To">🔍</button> <button class="remove-btn" title="Remove">🗑️</button> </div> `;
            this.elements.locationList.prepend(li);
        },

        renderUnfoundListItem(query, isError = false) {
            const li = document.createElement('li');
            li.classList.add('not-found');
            li.dataset.query = query;
            const message = isError ? 'Error searching' : 'Not found';
            li.innerHTML = ` <span class="location-name">"${query}" - ${message}</span> <div class="location-controls"> <button class="remove-btn" title="Remove">🗑️</button> </div> `;
            this.elements.locationList.prepend(li);
        },
        
        async geocode(query) {
            const myAppUserAgent = 'Internal-LocatorTool/4.5-SingleFile (Internal Use; sporadic)';
            const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`;
            const response = await fetch(url, { headers: { 'User-Agent': myAppUserAgent } });
            if (!response.ok) throw new Error(`Geocoding error (${response.status})`);
            return response.json();
        },

        startGeocoding() {
            const value = this.elements.locationsInput.value;
            this.geocodeQueue = value.split(/;|\n/).map(s => s.trim()).filter(Boolean);
            if (this.geocodeQueue.length > 0) {
                this.setLoadingState(true);
                this.processNextInGeocodeQueue();
                this.elements.locationsInput.value = '';
            }
        },
        
        processNextInGeocodeQueue() {
            if (this.geocodeQueue.length > 0) {
                const nextLocation = this.geocodeQueue.shift();
                setTimeout(() => this.handleLocationQuery(nextLocation), this.CONFIG.API_THROTTLE_MS);
            } else {
                this.setLoadingState(false);
            }
        },

        async handleLocationQuery(locationName) {
            try {
                const results = await this.geocode(locationName);
                const seenDisplayNames = new Set();
                const uniqueResults = results.filter(result => {
                    if (seenDisplayNames.has(result.display_name)) { return false; } 
                    else { seenDisplayNames.add(result.display_name); return true; }
                });
                if (uniqueResults.length === 0) {
                    this.renderUnfoundListItem(locationName);
                    this.processNextInGeocodeQueue();
                    return;
                }
                const isClearlyBetter = uniqueResults.length > 1 && (uniqueResults[0].importance - uniqueResults[1].importance > 0.3);
                if (uniqueResults.length === 1 || isClearlyBetter) {
                    this.placeLocation(uniqueResults[0], locationName);
                    this.processNextInGeocodeQueue();
                } else {
                    this.showAmbiguityPopup(uniqueResults, locationName);
                }
            } catch (error) {
                console.error(`Error for "${locationName}":`, error);
                this.renderUnfoundListItem(locationName, true);
                this.processNextInGeocodeQueue();
            }
        },
        
        setLoadingState(isLoading) {
            this.elements.locateBtn.disabled = isLoading;
            this.elements.locateBtnText.textContent = isLoading ? 'Adding...' : 'Add to Map';
            this.elements.locateBtnSpinner.classList.toggle('hidden', !isLoading);
        },

        showAmbiguityPopup(options, originalQuery) {
            this.ambiguityChoices = options; this.ambiguityOriginalQuery = originalQuery;
            this.elements.ambiguityMsg.textContent = `Multiple matches for "${originalQuery}":`;
            this.elements.ambiguitySelect.innerHTML = '';
            options.slice(0, 5).forEach((o, i) => this.elements.ambiguitySelect.add(new Option(o.display_name, String(i))));
            this.elements.ambiguityPopup.style.display = 'flex';
        },

        hideAmbiguityPopup() { this.elements.ambiguityPopup.style.display = 'none'; },

        resolveAmbiguity() {
            const selectedIndex = parseInt(this.elements.ambiguitySelect.value, 10);
            if (this.ambiguityChoices[selectedIndex]) {
                this.placeLocation(this.ambiguityChoices[selectedIndex], this.ambiguityOriginalQuery);
            }
            this.hideAmbiguityPopup(); this.processNextInGeocodeQueue();
        },

        skipAmbiguity() {
            this.renderUnfoundListItem(this.ambiguityOriginalQuery);
            this.hideAmbiguityPopup(); this.processNextInGeocodeQueue();
        }
    };

    App.init();
  </script>

</body>
</html>